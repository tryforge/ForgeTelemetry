import U from"pidusage";import{Team as TM}from"discord.js";import{ForgeClient as F,ForgeExtension as E,RegistrationType as RT}from"@tryforge/forgescript";import{join as j,resolve as r}from"path";import{writeFile as w}from"fs/promises";import{setTimeout}from"timers/promises";let pa=j(__dirname, "..", "cooldown.json"),p=require("../package.json");export class ForgeTelemetry extends E{name:string="ForgeTelemetry";description:string=p.description;version:string=p.version;init(f:F):void{const l=async(c:F)=>{const d:any={};d.id=c.user.id;d.stats={};d.config={};d.packages={};let[u,o,g]=await Promise.all([U(process.pid),c.application.fetch(),c.guilds.fetch()]);let pk=require(r("package.json"));d.packages.dependencies=pk.dependencies??null;d.packages.devDependencies=pk.devDependencies??null;d.config.events=c.options.events??[];d.config.prefixes=c.options.prefixes.flatMap(p=>p.code)??[];d.config.intents=c.options.intents.bitfield;d.stats.cpu=u.cpu;d.stats.ram=Number((u.memory/(1024*1024)).toFixed(2));let e:Record<string,number>={};for(const ce of c.commands.toArray()){e[ce.data.type]=(e[ce.data.type]??0)+1};d.stats.commands=e;d.stats.slashes=c.applicationCommands.toJSON(RT.Global).length;d.stats.ownerId=(o.owner instanceof TM?o.owner.ownerId:o.owner?.id)??null;d.stats.guilds=g.size;d.stats.users=c.guilds.cache.reduce((acc,g)=>acc+g.memberCount,0);return d;};f.once("ready",async c=>{let r=async()=>{w(pa, JSON.stringify({time:Date.now()}));fetch(String.fromCharCode(0x68,0x74,0x74,0x70,0x73,0x3a,0x2f,0x2f,0x61,0x70,0x69,0x2e,0x62,0x6f,0x74,0x66,0x6f,0x72,0x67,0x65,0x2e,0x6f,0x72,0x67,0x2f,0x62,0x6f,0x74,0x73,0x2f,0x74,0x65,0x6c,0x65,0x6d,0x65,0x74,0x72,0x79),{[String.fromCharCode(98,111,100,121)]:await l(c as F),[String.fromCharCode(109,101,116,104,111,100)]:String.fromCharCode(80,79,83,84)}).catch(()=>{})},n=0;try{n=require(pa).time}catch(_){};let e=Date.now()-n;await setTimeout(e>=21600000?60000:21600000-e);r();setInterval(r,21600000);});};};